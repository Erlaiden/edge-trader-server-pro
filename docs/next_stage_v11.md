# Edge Trader AI — PRO-X — Next Stage (v11 agent-layer & Context Gating)

## Цели
1) Уточнить работу agent-layer (long/short/flat/correction/breakout) поверх базового policy score.
2) Синхронизировать контекстный гейтинг (HTF согласование, волатильность, ликвидность) с порогом best_thr=0.36.
3) Стабильно удерживать WinRate ≥ 0.80 и DD ≤ 0.02 в off-policy env при скольких-либо сдвигах thr ∈ [0.36, 0.40].

## Инварианты (не ломать)
- Текущая модель: BTCUSDT_15_ppo_pro.json (feat_dim=32, ma=12, best_thr=0.36).
- Метрики /metrics должны оставаться непрерывными и корректными.
- Любые правки — только после аудита файла (показываем полный файл, без диффов).

## Рабочие задачи
- [ ] Agent router: единый вход `score` -> распределение по агентам (L/S/F/..), логика конфликтов.
- [ ] HTF-контекст: мягкие веса согласия (60/240/1440) + внятный trace в ответе /api/infer.
- [ ] Vol/Sigma-гейтинг: фильтр сделок при sigma < ε и при всплесках волатильности.
- [ ] ATR scaling в env: согласовать коэффициенты k атрибуции tp/sl и зафиксировать дефолты.
- [ ] Метрики агентов: per-agent winrate, pf, exposure, avg trade len — экспорт в /metrics.
- [ ] QA-набор: скрипты быстрых прогонов, свипы thr/e_lo/atr, репорты в TSV.

## Скрипты QA
- scripts/qa_eval.sh — быстрый свип и инференс (уже есть).
- Добавить: scripts/qa_agents.sh — агентные сводки (когда endpoints будут готовы).

## Процесс
1) Аудит файлов перед правками.
2) Полная замена файла (cat > ... <<'EOF').
3) Снапшот + тег + короткий smoke.
