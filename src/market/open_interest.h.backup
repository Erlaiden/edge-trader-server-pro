#pragma once
#include <string>
#include <curl/curl.h>
#include "../json.hpp"
#include <iostream>
#include <ctime>

using json = nlohmann::json;

namespace etai {

struct OpenInterestData {
    double open_interest;           // –¢–µ–∫—É—â–∏–π OI
    double oi_24h_ago;              // OI 24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥
    double oi_change_percent;       // % –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ 24—á
    double oi_trend;                // –¢—Ä–µ–Ω–¥: –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π/–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π
    std::string signal;             // "strong_bullish", "bullish", "bearish", "strong_bearish", "neutral"
    double confidence_boost;        // –ë–æ–Ω—É—Å –∫ confidence
    bool data_available;            // –£—Å–ø–µ—à–Ω–æ –ª–∏ –ø–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ
};

// Callback –¥–ª—è CURL
static size_t WriteCallback(void* contents, size_t size, size_t nmemb, std::string* userp) {
    userp->append((char*)contents, size * nmemb);
    return size * nmemb;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ Open Interest —Å Bybit API
inline OpenInterestData get_open_interest(const std::string& symbol, const std::string& interval = "1h") {
    OpenInterestData oi;
    oi.data_available = false;
    oi.confidence_boost = 0.0;
    
    CURL* curl = curl_easy_init();
    if (!curl) {
        std::cerr << "[OI] Failed to initialize CURL" << std::endl;
        oi.signal = "neutral";
        return oi;
    }
    
    // Bybit API endpoint –¥–ª—è Open Interest
    std::string url = "https://api.bybit.com/v5/market/open-interest?category=linear&symbol=" 
                    + symbol + "&intervalTime=" + interval + "&limit=25";
    
    std::string response_data;
    
    curl_easy_setopt(curl, CURLOPT_URL, url.c_str());
    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, WriteCallback);
    curl_easy_setopt(curl, CURLOPT_WRITEDATA, &response_data);
    curl_easy_setopt(curl, CURLOPT_TIMEOUT, 5L);
    curl_easy_setopt(curl, CURLOPT_FOLLOWLOCATION, 1L);
    
    CURLcode res = curl_easy_perform(curl);
    curl_easy_cleanup(curl);
    
    if (res != CURLE_OK) {
        std::cerr << "[OI] CURL failed: " << curl_easy_strerror(res) << std::endl;
        oi.signal = "neutral";
        return oi;
    }
    
    try {
        json j = json::parse(response_data);
        
        if (!j.contains("result") || !j["result"].contains("list") || j["result"]["list"].empty()) {
            std::cerr << "[OI] Invalid response format" << std::endl;
            oi.signal = "neutral";
            return oi;
        }
        
        auto list = j["result"]["list"];
        
        // –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (—Å–∞–º–æ–µ —Å–≤–µ–∂–µ–µ)
        oi.open_interest = std::stod(list[0]["openInterest"].get<std::string>());
        
        // –ó–Ω–∞—á–µ–Ω–∏–µ 24 —á–∞—Å–∞ –Ω–∞–∑–∞–¥ (24 —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞–∑–∞–¥ –ø—Ä–∏ 1h –∏–Ω—Ç–µ—Ä–≤–∞–ª–µ)
        size_t idx_24h = std::min((size_t)24, list.size() - 1);
        oi.oi_24h_ago = std::stod(list[idx_24h]["openInterest"].get<std::string>());
        
        // –†–∞—Å—á–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if (oi.oi_24h_ago > 0) {
            oi.oi_change_percent = ((oi.open_interest - oi.oi_24h_ago) / oi.oi_24h_ago) * 100.0;
        } else {
            oi.oi_change_percent = 0.0;
        }
        
        // –¢—Ä–µ–Ω–¥ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å–≤–µ—á–µ–π)
        double oi_5h_ago = std::stod(list[std::min((size_t)5, list.size()-1)]["openInterest"].get<std::string>());
        oi.oi_trend = (oi.open_interest - oi_5h_ago) / (oi_5h_ago > 0 ? oi_5h_ago : 1.0);
        
        oi.data_available = true;
        
        // =====================================================================
        // –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø OPEN INTEREST
        // =====================================================================
        
        // OI —Ä–∞—Å—Ç–µ—Ç + —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç = –±—ã—á–∏–π —Ç—Ä–µ–Ω–¥ (–Ω–æ–≤—ã–µ –ª–æ–Ω–≥–∏)
        // OI —Ä–∞—Å—Ç–µ—Ç + —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç = –º–µ–¥–≤–µ–∂–∏–π —Ç—Ä–µ–Ω–¥ (–Ω–æ–≤—ã–µ —à–æ—Ä—Ç—ã)
        // OI –ø–∞–¥–∞–µ—Ç + —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç = –∑–∞–∫—Ä—ã—Ç–∏–µ —à–æ—Ä—Ç–æ–≤ (short squeeze)
        // OI –ø–∞–¥–∞–µ—Ç + —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç = –∑–∞–∫—Ä—ã—Ç–∏–µ –ª–æ–Ω–≥–æ–≤ (long liquidation)
        
        if (oi.oi_change_percent > 15.0) {
            // –°–ò–õ–¨–ù–´–ô —Ä–æ—Å—Ç OI (>15% –∑–∞ 24—á)
            oi.signal = "strong_bullish";
            oi.confidence_boost = 20.0;
            // –ù—É–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è
            
        } else if (oi.oi_change_percent > 5.0) {
            // –£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç OI
            oi.signal = "bullish";
            oi.confidence_boost = 12.0;
            
        } else if (oi.oi_change_percent < -15.0) {
            // –°–ò–õ–¨–ù–û–ï –ø–∞–¥–µ–Ω–∏–µ OI (–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∑–∏—Ü–∏–π)
            oi.signal = "strong_bearish";
            oi.confidence_boost = -15.0;  // –®—Ç—Ä–∞—Ñ - –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
            
        } else if (oi.oi_change_percent < -5.0) {
            // –£–º–µ—Ä–µ–Ω–Ω–æ–µ –ø–∞–¥–µ–Ω–∏–µ OI
            oi.signal = "bearish";
            oi.confidence_boost = -8.0;
            
        } else {
            // OI —Å—Ç–∞–±–∏–ª–µ–Ω (-5% –¥–æ +5%)
            oi.signal = "neutral";
            oi.confidence_boost = 0.0;
        }
        
        std::cout << "[OI] Symbol: " << symbol 
                  << " | Current: " << (oi.open_interest / 1e6) << "M"
                  << " | 24h change: " << oi.oi_change_percent << "%"
                  << " | Signal: " << oi.signal << std::endl;
        
    } catch (const std::exception& e) {
        std::cerr << "[OI] Parse error: " << e.what() << std::endl;
        oi.signal = "neutral";
        oi.data_available = false;
    }
    
    return oi;
}

// –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ OI + price action
inline double analyze_oi_with_price(
    const OpenInterestData& oi, 
    double price_change_24h,
    const std::string& signal
) {
    if (!oi.data_available) {
        return 0.0;  // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö - –Ω–µ—Ç –±–æ–Ω—É—Å–∞
    }
    
    double boost = 0.0;
    
    // =====================================================================
    // –ü–†–ê–í–ò–õ–ê –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–ò OI + PRICE
    // =====================================================================
    
    // 1. OI —Ä–∞—Å—Ç–µ—Ç + —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç = STRONG BULLISH (–Ω–æ–≤—ã–µ –ª–æ–Ω–≥–∏ –≤—Ö–æ–¥—è—Ç)
    if (oi.oi_change_percent > 5.0 && price_change_24h > 2.0) {
        if (signal == "LONG") {
            boost = 25.0;  // –°—É–ø–µ—Ä —Å–∏–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ!
            std::cout << "[OI+PRICE] üöÄ STRONG BULLISH: Rising OI + Rising Price = New LONGS!" << std::endl;
        } else if (signal == "SHORT") {
            boost = -15.0;  // –ü—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–µ
            std::cout << "[OI+PRICE] ‚ö†Ô∏è Contradiction: OI bullish but signal SHORT" << std::endl;
        }
    }
    
    // 2. OI —Ä–∞—Å—Ç–µ—Ç + —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç = STRONG BEARISH (–Ω–æ–≤—ã–µ —à–æ—Ä—Ç—ã –≤—Ö–æ–¥—è—Ç)
    else if (oi.oi_change_percent > 5.0 && price_change_24h < -2.0) {
        if (signal == "SHORT") {
            boost = 25.0;
            std::cout << "[OI+PRICE] üîª STRONG BEARISH: Rising OI + Falling Price = New SHORTS!" << std::endl;
        } else if (signal == "LONG") {
            boost = -15.0;
            std::cout << "[OI+PRICE] ‚ö†Ô∏è Contradiction: OI bearish but signal LONG" << std::endl;
        }
    }
    
    // 3. OI –ø–∞–¥–∞–µ—Ç + —Ü–µ–Ω–∞ —Ä–∞—Å—Ç–µ—Ç = SHORT SQUEEZE (–∑–∞–∫—Ä—ã—Ç–∏–µ —à–æ—Ä—Ç–æ–≤)
    else if (oi.oi_change_percent < -3.0 && price_change_24h > 2.0) {
        if (signal == "LONG") {
            boost = 18.0;  // Short squeeze –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–æ—Å—Ç
            std::cout << "[OI+PRICE] üí• SHORT SQUEEZE: Falling OI + Rising Price!" << std::endl;
        }
    }
    
    // 4. OI –ø–∞–¥–∞–µ—Ç + —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç = LONG LIQUIDATION (–∑–∞–∫—Ä—ã—Ç–∏–µ –ª–æ–Ω–≥–æ–≤)
    else if (oi.oi_change_percent < -3.0 && price_change_24h < -2.0) {
        if (signal == "SHORT") {
            boost = 18.0;  // Liquidation cascade –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞–¥–µ–Ω–∏–µ
            std::cout << "[OI+PRICE] üí• LONG LIQUIDATION: Falling OI + Falling Price!" << std::endl;
        }
    }
    

    
    return boost;
}

} // namespace etai
